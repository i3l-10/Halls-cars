<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حجوزاتي - المستخدم</title>
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #009688;
            --secondary: #26a69a;
            --bg: #f4f7f6;
            --text: #333;
            --white: #fff;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; }
        body { background-color: var(--bg); color: var(--text); padding-bottom: 70px; }
        
        /* Utility Classes */
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; width: 100%; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn:hover { background: var(--secondary); }
        .hidden { display: none !important; }
        .card { background: var(--white); border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: var(--shadow); }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 10px; outline: none; }

        /* Navigation */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--white);
            display: flex; justify-content: space-around; padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000;
        }
        .nav-item { color: #888; text-align: center; font-size: 0.8rem; cursor: pointer; }
        .nav-item i { font-size: 1.2rem; display: block; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); }

        /* Login Screen */
        #auth-screen { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: white; z-index: 2000; position: fixed; top: 0; width: 100%; }
        .logo { font-size: 2rem; color: var(--primary); margin-bottom: 20px; }

        /* Home */
        .category-scroll { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 20px; }
        .cat-chip { padding: 8px 20px; background: white; border-radius: 20px; border: 1px solid #eee; white-space: nowrap; cursor: pointer; }
        .cat-chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Listing Item */
        .listing-img { width: 100%; height: 180px; object-fit: cover; border-radius: 10px; }
        .listing-info { padding: 10px 0; }
        .price { color: var(--primary); font-weight: bold; font-size: 1.1rem; }
        .rating { color: #f1c40f; font-size: 0.9rem; }
    </style>
</head>
<body>

    <!-- Auth Screen -->
    <div id="auth-screen">
        <div class="logo"><i class="fas fa-bookmark"></i> حجوزاتي</div>
        <div class="container" style="width: 100%;">
            <h2 style="margin-bottom: 20px; text-align: center;">تسجيل الدخول</h2>
            <input type="text" id="login-phone" placeholder="رقم الجوال">
            <input type="password" id="login-pass" placeholder="كلمة المرور">
            <button class="btn" onclick="login()">دخول</button>
            <p style="margin-top: 15px; text-align: center; color: #666; cursor: pointer;" onclick="toggleRegister()">ليس لديك حساب؟ سجل الآن</p>
            
            <div id="register-form" class="hidden" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                <input type="text" id="reg-name" placeholder="الاسم الكامل">
                <input type="text" id="reg-phone" placeholder="رقم الجوال">
                <input type="password" id="reg-pass" placeholder="كلمة المرور">
                <button class="btn" style="background: #333;" onclick="register()">إنشاء حساب</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-content" class="hidden">
        
        <!-- Home Screen -->
        <div id="home-screen" class="screen">
            <div class="container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>اكتشف الأماكن</h3>
                    <i class="fas fa-bell" style="color: #666;"></i>
                </div>

                <div class="category-scroll">
                    <div class="cat-chip active" onclick="filterListings('all')">الكل</div>
                    <div class="cat-chip" onclick="filterListings('hall')">قاعات</div>
                    <div class="cat-chip" onclick="filterListings('chalet')">شاليهات</div>
                    <div class="cat-chip" onclick="filterListings('car')">سيارات</div>
                </div>

                <div id="listings-container">
                    <!-- Listings loaded here -->
                </div>
            </div>
        </div>

        <!-- Bookings Screen -->
        <div id="bookings-screen" class="screen hidden">
            <div class="container">
                <h3>حجوزاتي السابقة</h3>
                <div id="my-bookings-list"></div>
            </div>
        </div>

        <!-- Profile Screen -->
        <div id="profile-screen" class="screen hidden">
            <div class="container">
                <div class="card" style="text-align: center; padding: 30px;">
                    <div style="width: 80px; height: 80px; background: #eee; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user fa-2x" style="color: #ccc;"></i>
                    </div>
                    <h3 id="profile-name">اسم المستخدم</h3>
                    <p id="profile-phone" style="color: #666;">0500000000</p>
                    <button class="btn" style="margin-top: 20px; background: #e74c3c;" onclick="logout()">تسجيل الخروج</button>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="showScreen('home-screen', this)">
                <i class="fas fa-search"></i> بحث
            </div>
            <div class="nav-item" onclick="showScreen('bookings-screen', this); loadMyBookings();">
                <i class="fas fa-calendar-check"></i> حجوزاتي
            </div>
            <div class="nav-item" onclick="showScreen('profile-screen', this)">
                <i class="fas fa-user"></i> حسابي
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let currentUser = JSON.parse(localStorage.getItem('user'));

        // Init
        if(currentUser) {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('profile-name').innerText = currentUser.name;
            document.getElementById('profile-phone').innerText = currentUser.phone;
            loadListings();
        }

        // Auth Functions
        function toggleRegister() {
            document.getElementById('register-form').classList.toggle('hidden');
        }

        async function register() {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const password = document.getElementById('reg-pass').value;

            const res = await fetch(`${API_URL}/register`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, phone, password })
            });
            const data = await res.json();
            if(res.ok) {
                alert(data.message);
                toggleRegister(); // Show login
            } else {
                alert(data.error);
            }
        }

        async function login() {
            const phone = document.getElementById('login-phone').value;
            const password = document.getElementById('login-pass').value;

            const res = await fetch(`${API_URL}/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ phone, password })
            });
            const data = await res.json();
            
            if(res.ok) {
                if(data.user.role !== 'user') {
                    alert('هذا التطبيق للمستخدمين فقط، يرجى استخدام بوابة الملاك أو الإدارة');
                    return;
                }
                localStorage.setItem('user', JSON.stringify(data.user));
                location.reload();
            } else {
                alert(data.error);
            }
        }

        function logout() {
            localStorage.removeItem('user');
            location.reload();
        }

        // App Functions
        function showScreen(screenId, navEl) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            
            if(navEl) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                navEl.classList.add('active');
            }
        }

        async function loadListings(type = null) {
            let url = `${API_URL}/listings`;
            if(type) url += `?type=${type}`;
            
            const res = await fetch(url);
            const listings = await res.json();
            
            const container = document.getElementById('listings-container');
            container.innerHTML = listings.map(item => `
                <div class="card">
                    <img src="${item.image_url || 'https://via.placeholder.com/400x200'}" class="listing-img" alt="${item.title}">
                    <div class="listing-info">
                        <div style="display:flex; justify-content:space-between;">
                            <h4>${item.title}</h4>
                            <span class="rating"><i class="fas fa-star"></i> 4.5</span>
                        </div>
                        <p style="color:#777; font-size:0.9rem; margin: 5px 0;"><i class="fas fa-map-marker-alt"></i> ${item.location}</p>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                            <span class="price">${item.price} ر.س / يوم</span>
                            <button class="btn" style="width: auto; padding: 8px 20px;" onclick="bookItem(${item.id}, ${item.price})">حجز</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterListings(type) {
            document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            loadListings(type === 'all' ? null : type);
        }

        async function bookItem(id, price) {
            if(!confirm(`هل تريد تأكيد الحجز بسعر ${price} ريال؟`)) return;
            
            const res = await fetch(`${API_URL}/bookings`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_id: currentUser.id,
                    listing_id: id,
                    date: new Date().toISOString().split('T')[0], // Today for simplicity
                    total_price: price
                })
            });
            const data = await res.json();
            alert(data.message || data.error);
        }

        async function loadMyBookings() {
            const res = await fetch(`${API_URL}/bookings/user/${currentUser.id}`);
            const bookings = await res.json();
            
            const container = document.getElementById('my-bookings-list');
            if(bookings.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding:20px;">لا توجد حجوزات سابقة</p>';
                return;
            }

            container.innerHTML = bookings.map(b => `
                <div class="card" style="border-right: 5px solid var(--primary);">
                    <h4>${b.title}</h4>
                    <p>التاريخ: ${b.date}</p>
                    <p>السعر: <b>${b.total_price} ر.س</b></p>
                    <span style="font-size:0.8rem; background:#e0f2f1; color:var(--primary); padding:2px 8px; border-radius:4px;">مؤكد</span>
                </div>
            `).join('');
        }
    </script>
</body>
</html>
